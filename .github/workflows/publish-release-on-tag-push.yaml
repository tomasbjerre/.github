name: Publish release on tag push

on:
  workflow_dispatch:
  workflow_call:
  push:
    tags:
      - "*"

jobs:
  build:
    runs-on: "ubuntu-latest"
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-tags: "true"
          fetch-depth: "0"
      - name: Setup java
        uses: actions/setup-java@v2
        with:
          distribution: "zulu"
          java-version: 17
      - uses: tomasbjerre/git-changelog-github-release@main
        with:
          draft: false
          template: |
            {{#with tags.[0]}}
            {{#ifContainsBreaking commits}}
            # üí£ Breaking changes

            {{#commits}}
            {{#ifCommitBreaking .}}
            - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{subString hash 0 5}}](https://github.com/{{ownerName}}/{{repoName}}/commit/{{hash}}) {{authorName}}) {{#eachCommitRefs .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitRefs}} {{#eachCommitFixes .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitFixes}}
            {{/ifCommitBreaking}}
            {{/commits}}

            {{/ifContainsBreaking}}
            {{#ifContainsType commits type='feat'}}
            # üöÄ Features

            {{#commits}}
            {{#ifCommitType . type='feat'}}
            - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{subString hash 0 5}}](https://github.com/{{ownerName}}/{{repoName}}/commit/{{hash}}) {{authorName}}) {{#eachCommitRefs .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitRefs}} {{#eachCommitFixes .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitFixes}}
            {{/ifCommitType}}
            {{/commits}}

            {{/ifContainsType}}
            {{#ifContainsType commits type='fix'}}
            # üêõ Bug Fixes

            {{#commits}}
            {{#ifCommitType . type='fix'}}
            - {{#eachCommitScope .}} **{{.}}** {{/eachCommitScope}} {{{commitDescription .}}} ([{{subString hash 0 5}}](https://github.com/{{ownerName}}/{{repoName}}/commit/{{hash}}) {{authorName}}) {{#eachCommitRefs .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitRefs}} {{#eachCommitFixes .}}{{#ifMatches . "^#[0-9]+"}} [{{.}}](https://github.com/{{ownerName}}/{{repoName}}/issues/{{subString . 1}}) {{/ifMatches}}{{/eachCommitFixes}}
            {{/ifCommitType}}
            {{/commits}}

            {{/ifContainsType}}
            {{#ifContainsType commits type='^($|(?!fix|feat|breaking))'}}
            # üß∞ Other changes

            {{#commits}}
            {{#ifCommitType . type='^$'}}
            **{{{messageTitle}}}**

            {{#messageBodyItems}}
            * {{.}} 
            {{/messageBodyItems}}

            [{{subString hash 0 5}}](https://github.com/{{ownerName}}/{{repoName}}/commit/{{hash}}) {{authorName}} *{{commitTime}}*

            {{/ifCommitType}}
            {{/commits}}

            {{/ifContainsType}}
            {{/with}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
